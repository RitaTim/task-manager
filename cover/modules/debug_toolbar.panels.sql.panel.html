<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
    <title>Test coverage report: debug_toolbar.panels.sql.panel</title>
    <style type="text/css" media="screen">
      a
      {
        color: #3d707a;
      }
      
      a:hover, a:active
      {
        color: #bf7d18;
      }
    
      body 
      {
        font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif;
        font-size: 13px;
      }
      
      .nav 
      {
        font-size: 12px;
        margin-left: 50px;
      }

      .ignored
      {
        color: #707070;
      }

      .executed 
      {
        color: #3d9900;
      }

      .missed 
      {
        color: red;
        font-weight: bold;
      }

      .excluded 
      {
        color: #6090f0;
        font-weight: lighter;
      }
    
      #content-header 
      {
        font-size: 12px;
        padding: 18px 0 18px 50px;
      }

      #content-header h1 
      {
        font-size: 16px;
        margin: 10px 0 0 0;
        color: #909090;
      }
      
      #module-name
      {
        color: #583707;
      }
    
      #content-header p
      {
        font-size: 13px;
        margin: 0;
        color: #909090;
      }

      #content-header .normal 
      {
        color: #609030;
      }

      #content-header .warning 
      {
        color: #d0a000;
      }

      #content-header .critical 
      {
        color: red;
      }
      
      #source-listing 
      {
        margin-bottom: 24px;
      }

      #source-listing ol 
      {
        padding: 0 0 0 50px;
        width: 90%;
        font-family: monospace;
        list-style-position: outside;
      }

      #source-listing ol li 
      {
        line-height: 18px;
        font-size: small;
      }
        
      #source-listing ol code 
      {
        padding:  0 .001em 0 0; /* Firefox doesn't render empty li's properly */
        font-size: medium;
        white-space: pre;
      }
   </style>
  </head>

  <body>

<div class="nav">
  <a href="debug_toolbar.panels.sql.forms.html">debug_toolbar.panels.sql.forms</a> &lt;&lt;
  <a href="../index.html">index</a>
  &gt;&gt; <a href="debug_toolbar.panels.sql.tracking.html">debug_toolbar.panels.sql.tracking</a>
</div>

<div id="content-header">
  <h1>
    <span id="module-name">debug_toolbar.panels.sql.panel</span>:
    133 total statements,
    <span class="critical">0.0% covered</span>
  </h1>
  <p>Generated: Thu 2015-05-07 01:13 UTC</p>
  <p>Source file: /usr/local/lib/python2.7/dist-packages/debug_toolbar/panels/sql/panel.py</p>
  <p>
    Stats:
    <span class="executed">0 executed</span>,
    <span class="missed">118 missed</span>,
    <span class="excluded">15 excluded</span>,
    <span class="ignored">78 ignored</span> 
  </p> 
</div>

<div id="source-listing">
  <ol>
    <li class="excluded"><code>from __future__ import absolute_import, unicode_literals</code></li>
<li class="ignored"><code></code></li>
<li class="excluded"><code>import uuid</code></li>
<li class="excluded"><code>from copy import copy</code></li>
<li class="excluded"><code>from collections import defaultdict</code></li>
<li class="ignored"><code></code></li>
<li class="excluded"><code>from django.conf.urls import url</code></li>
<li class="excluded"><code>from django.db import connections</code></li>
<li class="excluded"><code>from django.utils.translation import ugettext_lazy as _, ungettext_lazy as __</code></li>
<li class="ignored"><code></code></li>
<li class="excluded"><code>from debug_toolbar.panels import Panel</code></li>
<li class="excluded"><code>from debug_toolbar.panels.sql.forms import SQLSelectForm</code></li>
<li class="excluded"><code>from debug_toolbar.utils import render_stacktrace</code></li>
<li class="excluded"><code>from debug_toolbar.panels.sql.utils import reformat_sql, contrasting_color_generator</code></li>
<li class="excluded"><code>from debug_toolbar.panels.sql.tracking import wrap_cursor, unwrap_cursor</code></li>
<li class="excluded"><code>from debug_toolbar.panels.sql import views</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>def get_isolation_level_display(vendor, level):</code></li>
<li class="missed"><code>    if vendor == 'postgresql':</code></li>
<li class="excluded"><code>        import psycopg2.extensions</code></li>
<li class="missed"><code>        choices = {</code></li>
<li class="ignored"><code>            psycopg2.extensions.ISOLATION_LEVEL_AUTOCOMMIT: _("Autocommit"),</code></li>
<li class="ignored"><code>            psycopg2.extensions.ISOLATION_LEVEL_READ_UNCOMMITTED: _("Read uncommitted"),</code></li>
<li class="ignored"><code>            psycopg2.extensions.ISOLATION_LEVEL_READ_COMMITTED: _("Read committed"),</code></li>
<li class="ignored"><code>            psycopg2.extensions.ISOLATION_LEVEL_REPEATABLE_READ: _("Repeatable read"),</code></li>
<li class="ignored"><code>            psycopg2.extensions.ISOLATION_LEVEL_SERIALIZABLE: _("Serializable"),</code></li>
<li class="ignored"><code>        }</code></li>
<li class="ignored"><code>    else:</code></li>
<li class="missed"><code>        raise ValueError(vendor)</code></li>
<li class="missed"><code>    return choices.get(level)</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>def get_transaction_status_display(vendor, level):</code></li>
<li class="missed"><code>    if vendor == 'postgresql':</code></li>
<li class="excluded"><code>        import psycopg2.extensions</code></li>
<li class="missed"><code>        choices = {</code></li>
<li class="ignored"><code>            psycopg2.extensions.TRANSACTION_STATUS_IDLE: _("Idle"),</code></li>
<li class="ignored"><code>            psycopg2.extensions.TRANSACTION_STATUS_ACTIVE: _("Active"),</code></li>
<li class="ignored"><code>            psycopg2.extensions.TRANSACTION_STATUS_INTRANS: _("In transaction"),</code></li>
<li class="ignored"><code>            psycopg2.extensions.TRANSACTION_STATUS_INERROR: _("In error"),</code></li>
<li class="ignored"><code>            psycopg2.extensions.TRANSACTION_STATUS_UNKNOWN: _("Unknown"),</code></li>
<li class="ignored"><code>        }</code></li>
<li class="ignored"><code>    else:</code></li>
<li class="missed"><code>        raise ValueError(vendor)</code></li>
<li class="missed"><code>    return choices.get(level)</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>class SQLPanel(Panel):</code></li>
<li class="ignored"><code>    """</code></li>
<li class="ignored"><code>    Panel that displays information about the SQL queries run while processing</code></li>
<li class="ignored"><code>    the request.</code></li>
<li class="ignored"><code>    """</code></li>
<li class="missed"><code>    def __init__(self, *args, **kwargs):</code></li>
<li class="missed"><code>        super(SQLPanel, self).__init__(*args, **kwargs)</code></li>
<li class="missed"><code>        self._offset = dict((k, len(connections[k].queries)) for k in connections)</code></li>
<li class="missed"><code>        self._sql_time = 0</code></li>
<li class="missed"><code>        self._num_queries = 0</code></li>
<li class="missed"><code>        self._queries = []</code></li>
<li class="missed"><code>        self._databases = {}</code></li>
<li class="missed"><code>        self._transaction_status = {}</code></li>
<li class="missed"><code>        self._transaction_ids = {}</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def get_transaction_id(self, alias):</code></li>
<li class="missed"><code>        if alias not in connections:</code></li>
<li class="missed"><code>            return</code></li>
<li class="missed"><code>        conn = connections[alias].connection</code></li>
<li class="missed"><code>        if not conn:</code></li>
<li class="missed"><code>            return</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        if conn.vendor == 'postgresql':</code></li>
<li class="missed"><code>            cur_status = conn.get_transaction_status()</code></li>
<li class="ignored"><code>        else:</code></li>
<li class="missed"><code>            raise ValueError(conn.vendor)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        last_status = self._transaction_status.get(alias)</code></li>
<li class="missed"><code>        self._transaction_status[alias] = cur_status</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        if not cur_status:</code></li>
<li class="ignored"><code>            # No available state</code></li>
<li class="missed"><code>            return None</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        if cur_status != last_status:</code></li>
<li class="missed"><code>            if cur_status:</code></li>
<li class="missed"><code>                self._transaction_ids[alias] = uuid.uuid4().hex</code></li>
<li class="ignored"><code>            else:</code></li>
<li class="missed"><code>                self._transaction_ids[alias] = None</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        return self._transaction_ids[alias]</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def record(self, alias, **kwargs):</code></li>
<li class="missed"><code>        self._queries.append((alias, kwargs))</code></li>
<li class="missed"><code>        if alias not in self._databases:</code></li>
<li class="missed"><code>            self._databases[alias] = {</code></li>
<li class="ignored"><code>                'time_spent': kwargs['duration'],</code></li>
<li class="ignored"><code>                'num_queries': 1,</code></li>
<li class="ignored"><code>            }</code></li>
<li class="ignored"><code>        else:</code></li>
<li class="missed"><code>            self._databases[alias]['time_spent'] += kwargs['duration']</code></li>
<li class="missed"><code>            self._databases[alias]['num_queries'] += 1</code></li>
<li class="missed"><code>        self._sql_time += kwargs['duration']</code></li>
<li class="missed"><code>        self._num_queries += 1</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    # Implement the Panel API</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    nav_title = _("SQL")</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    @property</code></li>
<li class="ignored"><code>    def nav_subtitle(self):</code></li>
<li class="missed"><code>        return __("%d query in %.2fms", "%d queries in %.2fms",</code></li>
<li class="ignored"><code>                  self._num_queries) % (self._num_queries, self._sql_time)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    @property</code></li>
<li class="ignored"><code>    def title(self):</code></li>
<li class="missed"><code>        count = len(self._databases)</code></li>
<li class="missed"><code>        return __('SQL queries from %(count)d connection',</code></li>
<li class="ignored"><code>                  'SQL queries from %(count)d connections',</code></li>
<li class="ignored"><code>                  count) % {'count': count}</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    template = 'debug_toolbar/panels/sql.html'</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    @classmethod</code></li>
<li class="ignored"><code>    def get_urls(cls):</code></li>
<li class="missed"><code>        return [</code></li>
<li class="ignored"><code>            url(r'^sql_select/$', views.sql_select, name='sql_select'),</code></li>
<li class="ignored"><code>            url(r'^sql_explain/$', views.sql_explain, name='sql_explain'),</code></li>
<li class="ignored"><code>            url(r'^sql_profile/$', views.sql_profile, name='sql_profile'),</code></li>
<li class="ignored"><code>        ]</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def enable_instrumentation(self):</code></li>
<li class="ignored"><code>        # This is thread-safe because database connections are thread-local.</code></li>
<li class="missed"><code>        for connection in connections.all():</code></li>
<li class="missed"><code>            wrap_cursor(connection, self)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def disable_instrumentation(self):</code></li>
<li class="missed"><code>        for connection in connections.all():</code></li>
<li class="missed"><code>            unwrap_cursor(connection)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def process_response(self, request, response):</code></li>
<li class="missed"><code>        colors = contrasting_color_generator()</code></li>
<li class="missed"><code>        trace_colors = defaultdict(lambda: next(colors))</code></li>
<li class="missed"><code>        if self._queries:</code></li>
<li class="missed"><code>            width_ratio_tally = 0</code></li>
<li class="missed"><code>            factor = int(256.0 / (len(self._databases) * 2.5))</code></li>
<li class="missed"><code>            for n, db in enumerate(self._databases.values()):</code></li>
<li class="missed"><code>                rgb = [0, 0, 0]</code></li>
<li class="missed"><code>                color = n % 3</code></li>
<li class="missed"><code>                rgb[color] = 256 - n / 3 * factor</code></li>
<li class="missed"><code>                nn = color</code></li>
<li class="ignored"><code>                # XXX: pretty sure this is horrible after so many aliases</code></li>
<li class="missed"><code>                while rgb[color] &lt; factor:</code></li>
<li class="missed"><code>                    nc = min(256 - rgb[color], 256)</code></li>
<li class="missed"><code>                    rgb[color] += nc</code></li>
<li class="missed"><code>                    nn += 1</code></li>
<li class="missed"><code>                    if nn &gt; 2:</code></li>
<li class="missed"><code>                        nn = 0</code></li>
<li class="missed"><code>                    rgb[nn] = nc</code></li>
<li class="missed"><code>                db['rgb_color'] = rgb</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>            trans_ids = {}</code></li>
<li class="missed"><code>            trans_id = None</code></li>
<li class="missed"><code>            i = 0</code></li>
<li class="missed"><code>            for alias, query in self._queries:</code></li>
<li class="missed"><code>                trans_id = query.get('trans_id')</code></li>
<li class="missed"><code>                last_trans_id = trans_ids.get(alias)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>                if trans_id != last_trans_id:</code></li>
<li class="missed"><code>                    if last_trans_id:</code></li>
<li class="missed"><code>                        self._queries[(i - 1)][1]['ends_trans'] = True</code></li>
<li class="missed"><code>                    trans_ids[alias] = trans_id</code></li>
<li class="missed"><code>                    if trans_id:</code></li>
<li class="missed"><code>                        query['starts_trans'] = True</code></li>
<li class="missed"><code>                if trans_id:</code></li>
<li class="missed"><code>                    query['in_trans'] = True</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>                query['alias'] = alias</code></li>
<li class="missed"><code>                if 'iso_level' in query:</code></li>
<li class="missed"><code>                    query['iso_level'] = get_isolation_level_display(query['vendor'],</code></li>
<li class="ignored"><code>                                                                     query['iso_level'])</code></li>
<li class="missed"><code>                if 'trans_status' in query:</code></li>
<li class="missed"><code>                    query['trans_status'] = get_transaction_status_display(query['vendor'],</code></li>
<li class="ignored"><code>                                                                           query['trans_status'])</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>                query['form'] = SQLSelectForm(auto_id=None, initial=copy(query))</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>                if query['sql']:</code></li>
<li class="missed"><code>                    query['sql'] = reformat_sql(query['sql'])</code></li>
<li class="missed"><code>                query['rgb_color'] = self._databases[alias]['rgb_color']</code></li>
<li class="missed"><code>                try:</code></li>
<li class="missed"><code>                    query['width_ratio'] = (query['duration'] / self._sql_time) * 100</code></li>
<li class="missed"><code>                    query['width_ratio_relative'] = (</code></li>
<li class="ignored"><code>                        100.0 * query['width_ratio'] / (100.0 - width_ratio_tally))</code></li>
<li class="missed"><code>                except ZeroDivisionError:</code></li>
<li class="missed"><code>                    query['width_ratio'] = 0</code></li>
<li class="missed"><code>                    query['width_ratio_relative'] = 0</code></li>
<li class="missed"><code>                query['start_offset'] = width_ratio_tally</code></li>
<li class="missed"><code>                query['end_offset'] = query['width_ratio'] + query['start_offset']</code></li>
<li class="missed"><code>                width_ratio_tally += query['width_ratio']</code></li>
<li class="missed"><code>                query['stacktrace'] = render_stacktrace(query['stacktrace'])</code></li>
<li class="missed"><code>                i += 1</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>                query['trace_color'] = trace_colors[query['stacktrace']]</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>            if trans_id:</code></li>
<li class="missed"><code>                self._queries[(i - 1)][1]['ends_trans'] = True</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        self.record_stats({</code></li>
<li class="ignored"><code>            'databases': sorted(self._databases.items(), key=lambda x: -x[1]['time_spent']),</code></li>
<li class="ignored"><code>            'queries': [q for a, q in self._queries],</code></li>
<li class="ignored"><code>            'sql_time': self._sql_time,</code></li>
<li class="ignored"><code>        })</code></li>
  </ol>
</div>

<div class="nav">
  <a href="debug_toolbar.panels.sql.forms.html">debug_toolbar.panels.sql.forms</a> &lt;&lt;
  <a href="../index.html">index</a>
  &gt;&gt; <a href="debug_toolbar.panels.sql.tracking.html">debug_toolbar.panels.sql.tracking</a>
</div>

  </body>
</html>

