<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
    <title>Test coverage report: task.views</title>
    <style type="text/css" media="screen">
      a
      {
        color: #3d707a;
      }
      
      a:hover, a:active
      {
        color: #bf7d18;
      }
    
      body 
      {
        font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif;
        font-size: 13px;
      }
      
      .nav 
      {
        font-size: 12px;
        margin-left: 50px;
      }

      .ignored
      {
        color: #707070;
      }

      .executed 
      {
        color: #3d9900;
      }

      .missed 
      {
        color: red;
        font-weight: bold;
      }

      .excluded 
      {
        color: #6090f0;
        font-weight: lighter;
      }
    
      #content-header 
      {
        font-size: 12px;
        padding: 18px 0 18px 50px;
      }

      #content-header h1 
      {
        font-size: 16px;
        margin: 10px 0 0 0;
        color: #909090;
      }
      
      #module-name
      {
        color: #583707;
      }
    
      #content-header p
      {
        font-size: 13px;
        margin: 0;
        color: #909090;
      }

      #content-header .normal 
      {
        color: #609030;
      }

      #content-header .warning 
      {
        color: #d0a000;
      }

      #content-header .critical 
      {
        color: red;
      }
      
      #source-listing 
      {
        margin-bottom: 24px;
      }

      #source-listing ol 
      {
        padding: 0 0 0 50px;
        width: 90%;
        font-family: monospace;
        list-style-position: outside;
      }

      #source-listing ol li 
      {
        line-height: 18px;
        font-size: small;
      }
        
      #source-listing ol code 
      {
        padding:  0 .001em 0 0; /* Firefox doesn't render empty li's properly */
        font-size: medium;
        white-space: pre;
      }
   </style>
  </head>

  <body>

<div class="nav">
  <a href="task.models.html">task.models</a> &lt;&lt;
  <a href="../index.html">index</a>
  &gt;&gt; <a href="user_profile.admin.html">user_profile.admin</a>
</div>

<div id="content-header">
  <h1>
    <span id="module-name">task.views</span>:
    204 total statements,
    <span class="critical">7.4% covered</span>
  </h1>
  <p>Generated: Thu 2015-05-07 01:13 UTC</p>
  <p>Source file: /home/rita/Documents/task_manager/task/views.py</p>
  <p>
    Stats:
    <span class="executed">14 executed</span>,
    <span class="missed">174 missed</span>,
    <span class="excluded">16 excluded</span>,
    <span class="ignored">73 ignored</span> 
  </p> 
</div>

<div id="source-listing">
  <ol>
    <li class="ignored"><code>#-*-coding: utf-8 -*-</code></li>
<li class="excluded"><code>from django.core.context_processors import csrf</code></li>
<li class="excluded"><code>from django.http.response   import HttpResponse, Http404</code></li>
<li class="excluded"><code>from django.core.exceptions import ObjectDoesNotExist</code></li>
<li class="excluded"><code>from django.shortcuts       import render_to_response, redirect</code></li>
<li class="excluded"><code>from project.models         import Project</code></li>
<li class="excluded"><code>from iteration.models       import Iteration</code></li>
<li class="excluded"><code>from notification.models    import Notification</code></li>
<li class="excluded"><code>from models                 import Task</code></li>
<li class="excluded"><code>from forms                  import TaskForm</code></li>
<li class="excluded"><code>from task_manager.utils     import create_notification</code></li>
<li class="excluded"><code>from datetime               import datetime, timedelta</code></li>
<li class="excluded"><code>from django.utils           import timezone</code></li>
<li class="excluded"><code>from django.core.cache      import cache</code></li>
<li class="excluded"><code>from django.db.models       import Q</code></li>
<li class="excluded"><code>import json</code></li>
<li class="excluded"><code>import logging</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>def show_tasks(request):</code></li>
<li class="missed"><code>	args = {}</code></li>
<li class="missed"><code>	args['cache'] = cache.get_many( ['project_id', 'project_title', 'user_name', 'iterate_id'] )</code></li>
<li class="missed"><code>	args['iterations'] = Iteration.objects.filter(project=args['cache']['project_id']).values('id', 'title')</code></li>
<li class="missed"><code>	return render_to_response('tasks.html', args)</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>def load_table_tasks(request):</code></li>
<li class="missed"><code>	if 'iteration_id' in request.GET:</code></li>
<li class="missed"><code>		tasks = Task.objects.filter(project=cache.get('project_id'), iterate=request.GET['iteration_id']).values('title', 'id', 'type_task', 'assigned__username', 'status', 'updated')</code></li>
<li class="missed"><code>	return render_to_response('table_tasks.html', {'tasks' : tasks})</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>def show_lst_not_dev(request):</code></li>
<li class="missed"><code>	args = {}</code></li>
<li class="missed"><code>	project_id = cache.get('project_id')</code></li>
<li class="missed"><code>	args['tasks'] = Task.objects.filter( status="not_dev", assigned=None, project=project_id).values('title', 'id', 'text', 'priority')</code></li>
<li class="missed"><code>	return render_to_response('lst_not_dev.html', args)</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>def show_dashboard(request):</code></li>
<li class="missed"><code>	args = {}</code></li>
<li class="missed"><code>	args.update(csrf(request))</code></li>
<li class="missed"><code>	args['cache'] = cache.get_many([ 'project_id', 'iterate_id', 'project_title', 'user_name', 'user_id'])</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>	try:</code></li>
<li class="missed"><code>		args['iterations'] = Iteration.objects.filter(project = args['cache']['project_id'] ).values('title', 'id')</code></li>
<li class="missed"><code>	except Iteration.DoesNotExist:</code></li>
<li class="missed"><code>		args['iterations'] = []</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>	return render_to_response('dashboard.html', args)</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>def task(request, id_task = '0'):</code></li>
<li class="missed"><code>	if request.method == "POST":</code></li>
<li class="missed"><code>		if id_task != '0':</code></li>
<li class="missed"><code>			task = Task.objects.get(id = id_task)</code></li>
<li class="missed"><code>			form = TaskForm(request.POST, instance = task)</code></li>
<li class="ignored"><code>		else:</code></li>
<li class="missed"><code>			form = TaskForm(request.POST,  request.FILES)</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>		if not form.is_valid():</code></li>
<li class="missed"><code>			return HttpResponse("Форма не валидна")</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>		saved_task = form.save()</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>		if saved_task.assigned:</code></li>
<li class="missed"><code>			if id_task != saved_task.id:</code></li>
<li class="missed"><code>				if Notification.objects.filter(task=saved_task).exclude(action="change_iter"):</code></li>
<li class="missed"><code>					Notification.objects.filter(task=saved_task).exclude(action="change_iter").update(user=saved_task.assigned, action="assigned")</code></li>
<li class="ignored"><code>				else:</code></li>
<li class="missed"><code>					Notification.objects.create(action="assigned", user=saved_task.assigned, task=saved_task)</code></li>
<li class="ignored"><code>		else:</code></li>
<li class="missed"><code>			if Notification.objects.filter(task=saved_task).exclude(action="change_iter"):</code></li>
<li class="missed"><code>				Notification.objects.filter(task=saved_task).update(action="added", user=None)</code></li>
<li class="ignored"><code>			else:</code></li>
<li class="missed"><code>				Notification.objects.create(action="added", task=saved_task, user=None, project=saved_task.project)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>		return redirect(request.META.get('HTTP_REFERER','/'))</code></li>
<li class="ignored"><code>	else: # GET</code></li>
<li class="missed"><code>		args={}</code></li>
<li class="missed"><code>		args.update(csrf(request))</code></li>
<li class="missed"><code>		contents = request.GET['contents']</code></li>
<li class="missed"><code>		if id_task != '0':</code></li>
<li class="missed"><code>			if contents == 'describe' or  contents == 'all_form':</code></li>
<li class="missed"><code>				args['task'] = Task.objects.filter(id = id_task).values('title', 'id', 'text', 'project__title', 'iterate__title', 'type_task', 'status', 'assigned__username', 'entrasted__username', 'main_task__id', 'main_task__title')[0]</code></li>
<li class="missed"><code>			if contents == 'edit' or contents == 'all_form':</code></li>
<li class="missed"><code>				task = Task.objects.get(id = id_task)</code></li>
<li class="missed"><code>				args['form'] = TaskForm(instance = task)</code></li>
<li class="missed"><code>				args['task_id'] = task.id</code></li>
<li class="missed"><code>			args['subtasks'] = Task.objects.filter(main_task = id_task).values('title', 'id', 'status')</code></li>
<li class="ignored"><code>		else:</code></li>
<li class="missed"><code>			args['form'] = TaskForm()</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>		return render_to_response('task.html', args)</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>def get_tasks(request, id_project = 0, id_iteration = 0, which_tasks = '0'):</code></li>
<li class="missed"><code>	if request.method == 'POST':</code></li>
<li class="missed"><code>		return HttpResponse("Ожидался метод GET")</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>	id_project 	    = request.GET['id_project']   if ('id_project' in request.GET) else 0</code></li>
<li class="missed"><code>	id_iteration 	= request.GET['id_iteration'] if ('id_iteration' in request.GET) else 0</code></li>
<li class="missed"><code>	which_tasks 	= request.GET['which_tasks']  if ('which_tasks' in request.GET) else 0</code></li>
<li class="missed"><code>	name_user 		= request.user</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>	if id_project :</code></li>
<li class="missed"><code>		try:</code></li>
<li class="missed"><code>			tasks = Task.objects.filter(project = id_project)</code></li>
<li class="missed"><code>		except Task.ObjectDoesNotExist:</code></li>
<li class="missed"><code>			return HttpResponse( json.dumps( { 'empty' : 1 } ), mimetype='application/json')</code></li>
<li class="ignored"><code>	else:</code></li>
<li class="missed"><code>		try:</code></li>
<li class="missed"><code>			tasks = Task.objects.filter()</code></li>
<li class="missed"><code>		except Task.ObjectDoesNotExist:</code></li>
<li class="missed"><code>			return HttpResponse( json.dumps( { 'empty' : 1 } ), mimetype='application/json')</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>	if tasks == []:</code></li>
<li class="missed"><code>		return HttpResponse( json.dumps( { 'empty' : 1 } ), mimetype='application/json')</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>	if id_iteration :</code></li>
<li class="missed"><code>		tasks = tasks.filter(iterate = id_iteration)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>	if which_tasks != '0' :</code></li>
<li class="missed"><code>		tasks = tasks.filter(assigned = request.user.id)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>	tasks = tasks.values('id', 'title', 'text', 'priority', 'assigned__username', 'type_task', 'status', 'iterate', 'main_task')</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>	tasks_to_do 		= []</code></li>
<li class="missed"><code>	tasks_in_progress 	= []</code></li>
<li class="missed"><code>	tasks_test			= []</code></li>
<li class="missed"><code>	tasks_done			= []</code></li>
<li class="missed"><code>	tasks_not_dev		= []</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>	for task in tasks:</code></li>
<li class="missed"><code>		task['style'] = _get_style_priority(task['priority'])</code></li>
<li class="missed"><code>		if task['status']   == "not_dev":</code></li>
<li class="missed"><code>			tasks_not_dev.append(task)</code></li>
<li class="missed"><code>		elif task['status'] ==	"to_do":</code></li>
<li class="missed"><code>			tasks_to_do.append(task)</code></li>
<li class="missed"><code>		elif task['status'] == "in_progress":</code></li>
<li class="missed"><code>			tasks_in_progress.append(task)</code></li>
<li class="missed"><code>		elif task['status'] == "test":</code></li>
<li class="missed"><code>			tasks_test.append(task)</code></li>
<li class="missed"><code>		elif task['status'] == "done":</code></li>
<li class="missed"><code>			tasks_done.append(task)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>	data = json.dumps({'tasks_not_dev' : tasks_not_dev, 'tasks_in_progress' : tasks_in_progress, 'tasks_test' : tasks_test,  'tasks_done' : tasks_done,  'tasks_to_do' : tasks_to_do})</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>	return HttpResponse(data, mimetype='application/json')</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>def get_progress_bar_user(request, user_id = None, iterate_id = None):</code></li>
<li class="missed"><code>	for_statistic = False</code></li>
<li class="missed"><code>	if 'user_id' in request.GET:</code></li>
<li class="missed"><code>		user_id = request.GET['user_id']</code></li>
<li class="missed"><code>	elif not user_id:</code></li>
<li class="missed"><code>		user_id = cache.get('user_id')</code></li>
<li class="ignored"><code>	else:</code></li>
<li class="missed"><code>		for_statistic = True</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>	if 'iterate_id' in request.GET:</code></li>
<li class="missed"><code>		iterate_id = request.GET['iterate_id']</code></li>
<li class="missed"><code>	elif not iterate_id:</code></li>
<li class="missed"><code>		iterate_id = cache.get('iterate_id')</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>	iterate = Iteration.objects.filter(id = iterate_id).values('start_line', 'dead_line')[0]</code></li>
<li class="missed"><code>	iterate_time = {</code></li>
<li class="ignored"><code>		'start_line' : iterate['start_line'].strftime('%Y-%m-%d %H:%M'),</code></li>
<li class="ignored"><code>		'dead_line'  : iterate['dead_line' ].strftime('%Y-%m-%d %H:%M'),</code></li>
<li class="ignored"><code>	}</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>	tasks  = Task.objects.filter( Q(assigned = user_id) &amp; Q(iterate = iterate_id) &amp; ( Q(status = 'in_progress') | Q(status = 'done') ) ).order_by('-status').values('status', 'start_time', 'end_time', 'title', 'id', 'priority')</code></li>
<li class="missed"><code>	to_progress_bar = []</code></li>
<li class="missed"><code>	sum_work_time = timedelta(0)</code></li>
<li class="missed"><code>	today_time = timezone.now()</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>	for task in tasks:</code></li>
<li class="missed"><code>		if task['status'] == "done":</code></li>
<li class="missed"><code>			task['perform_time'] = task['end_time'] - task['start_time']</code></li>
<li class="ignored"><code>		else:</code></li>
<li class="missed"><code>			task['perform_time'] = today_time - task['start_time']</code></li>
<li class="missed"><code>		sum_work_time += task['perform_time']</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>	for task in tasks:</code></li>
<li class="missed"><code>		data_task = {</code></li>
<li class="ignored"><code>			'id'           : task['id'],</code></li>
<li class="ignored"><code>			'width'        : (task['perform_time'].total_seconds() * 100) / sum_work_time.total_seconds(),</code></li>
<li class="ignored"><code>			'perform_time' : str(task['perform_time']).split('.')[0],</code></li>
<li class="ignored"><code>			'title'        : task['title'],</code></li>
<li class="ignored"><code>			'css_class'    : 'progress-bar-striped active '+_get_class_progress_by_priority(task['priority']) if task['status'] == 'in_progress' else _get_class_progress_by_priority(task['priority'])</code></li>
<li class="ignored"><code>		}</code></li>
<li class="missed"><code>		to_progress_bar.append(data_task)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>	res_data = { 'all_time': str(sum_work_time).split('.')[0], 'progress_bar' : to_progress_bar, 'iterate_time' : iterate_time }</code></li>
<li class="missed"><code>	if not for_statistic:</code></li>
<li class="missed"><code>		return HttpResponse(json.dumps(res_data), content_type='application/json')</code></li>
<li class="ignored"><code>	else:</code></li>
<li class="missed"><code>		return res_data</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>def statistic_users(request):</code></li>
<li class="missed"><code>	args = {}</code></li>
<li class="missed"><code>	args['cache'] = cache.get_many( [ 'project_id', 'user_name', 'project_title' ])</code></li>
<li class="missed"><code>	users         = _get_users_project( args['cache']['project_id'] )</code></li>
<li class="missed"><code>	iterate_id    = request.GET['iterate_id'] if 'iterate_id' in request.GET else cache.get('iterate_id')</code></li>
<li class="missed"><code>	data_users = []</code></li>
<li class="missed"><code>	for user in users:</code></li>
<li class="missed"><code>		data_users.append({</code></li>
<li class="ignored"><code>			'user_name' : user['assigned__username'],</code></li>
<li class="ignored"><code>			'user_id'   : user['assigned'],</code></li>
<li class="ignored"><code>		})</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>	args['data_users'] = data_users</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>	try:</code></li>
<li class="missed"><code>		args['iterations'] = Iteration.objects.filter(project = args['cache']['project_id'] ).values('title', 'id')</code></li>
<li class="missed"><code>	except Iteration.DoesNotExist:</code></li>
<li class="missed"><code>		args['iterations'] = []</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>	return render_to_response('statistic.html', args)</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>def get_progress_users(request, iterate_id = None, lst_users_id = []):</code></li>
<li class="missed"><code>	iterate_id   = request.GET['iterate_id'] if 'iterate_id' in request.GET else cache.get('iterate_id')</code></li>
<li class="missed"><code>	lst_users_id = json.loads(request.GET['lst_users_id']) if 'lst_users_id' in request.GET else []</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>	args = {}</code></li>
<li class="missed"><code>	for user_id in lst_users_id:</code></li>
<li class="missed"><code>		args[user_id] = get_progress_bar_user( request = request, user_id = user_id, iterate_id = iterate_id )</code></li>
<li class="missed"><code>	return HttpResponse(json.dumps(args), content_type='application/json')</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>def _get_users_project(project_id):</code></li>
<li class="missed"><code>	project_id = project_id if project_id else cache.get('project_id')</code></li>
<li class="missed"><code>	return Task.objects.filter(project = project_id).exclude(assigned = None).values('assigned', 'assigned__username').distinct()</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>def _get_class_progress_by_priority(priority):</code></li>
<li class="missed"><code>	if priority   == 1:</code></li>
<li class="missed"><code>		return 'progress-bar-warning'</code></li>
<li class="missed"><code>	elif priority == 2:</code></li>
<li class="missed"><code>		return 'progress-bar-success'</code></li>
<li class="missed"><code>	elif priority == 3:</code></li>
<li class="missed"><code>		return 'progress-bar-info'</code></li>
<li class="missed"><code>	elif priority == 4:</code></li>
<li class="missed"><code>		return 'progress-bar-danger'</code></li>
<li class="missed"><code>	elif priority &gt;  4:</code></li>
<li class="missed"><code>		return 'progress-bar-black'</code></li>
<li class="ignored"><code>	else:</code></li>
<li class="missed"><code>		return ''</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>def _get_style_priority(priority):</code></li>
<li class="missed"><code>	if priority &gt; 4:</code></li>
<li class="missed"><code>		return "priority_max"</code></li>
<li class="ignored"><code>	else:</code></li>
<li class="missed"><code>		return "priority_" + str(priority)</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>def change_status(request, id_task = "", new_status = ""):</code></li>
<li class="missed"><code>	args = {}</code></li>
<li class="missed"><code>	id_task    = request.GET['id_task']</code></li>
<li class="missed"><code>	task = Task.objects.get(id = id_task)</code></li>
<li class="missed"><code>	new_status = request.GET['new_status']</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>	if task.status == "to_do" and new_status == "in_progress":</code></li>
<li class="missed"><code>		start_time = datetime.now()</code></li>
<li class="missed"><code>		Task.objects.filter(id = id_task).update(status = new_status, start_time = start_time)</code></li>
<li class="missed"><code>	elif new_status == "done":</code></li>
<li class="missed"><code>		end_time = datetime.now()</code></li>
<li class="missed"><code>		Task.objects.filter(id = id_task).update(status = new_status, end_time = end_time)</code></li>
<li class="ignored"><code>	else:</code></li>
<li class="missed"><code>		Task.objects.filter(id = id_task).update(status = new_status)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>	return HttpResponse(request)</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>def assign_for_user(request):</code></li>
<li class="missed"><code>	args = {}</code></li>
<li class="missed"><code>	if 'id_user' in request.GET:</code></li>
<li class="missed"><code>		id_user = request.GET['id_user']</code></li>
<li class="ignored"><code>	else:</code></li>
<li class="missed"><code>		id_user = request.user.id</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>	if 'tasks_id' in request.GET:</code></li>
<li class="missed"><code>		args['data'] = json.loads(request.GET['tasks_id'])</code></li>
<li class="missed"><code>		tasks_id = json.loads(request.GET['tasks_id'])</code></li>
<li class="missed"><code>		Task.objects.filter(id__in = tasks_id).update(assigned = id_user, status = "to_do")</code></li>
<li class="missed"><code>	return HttpResponse(request)</code></li>
  </ol>
</div>

<div class="nav">
  <a href="task.models.html">task.models</a> &lt;&lt;
  <a href="../index.html">index</a>
  &gt;&gt; <a href="user_profile.admin.html">user_profile.admin</a>
</div>

  </body>
</html>

